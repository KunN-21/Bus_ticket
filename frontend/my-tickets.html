<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>V√© c·ªßa t√¥i - VOOBUS</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="assets/styles/core/main.css">
  <link rel="stylesheet" href="assets/styles/components/header.css">
  <link rel="stylesheet" href="assets/styles/components/footer.css">
  <link rel="stylesheet" href="assets/styles/components/toast.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f5f5;
    }

    .tickets-section {
      min-height: 100vh;
      padding: 80px 20px 40px;
      background: linear-gradient(135deg, #FF6600 0%, #FF8C42 100%);
    }

    .tickets-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .btn-back {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      text-decoration: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 24px;
      transition: all 0.3s;
      backdrop-filter: blur(10px);
    }

    .btn-back:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateX(-4px);
    }

    .page-title {
      color: white;
      text-align: center;
      margin-bottom: 40px;
    }

    .page-title h2 {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .page-title p {
      font-size: 16px;
      opacity: 0.95;
    }

    .tickets-grid {
      display: grid;
      gap: 20px;
    }

    .ticket-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      gap: 16px;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .ticket-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
    }

    .ticket-status-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-paid {
      background: #4caf50;
      color: white;
    }

    .status-pending {
      background: #ff9800;
      color: white;
    }

    .status-cancelled {
      background: #f44336;
      color: white;
    }

    .ticket-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding-right: 80px;
    }

    .ticket-route {
      font-size: 20px;
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
    }

    .ticket-meta {
      font-size: 13px;
      color: #666;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .ticket-meta span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .ticket-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      padding: 16px;
      background: #f9f9f9;
      border-radius: 12px;
    }

    .detail-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .detail-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #FF6600 0%, #FF8C42 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
    }

    .detail-content {
      flex: 1;
    }

    .detail-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 2px;
    }

    .detail-value {
      font-size: 15px;
      font-weight: 600;
      color: #333;
    }

    .ticket-price {
      font-size: 24px;
      font-weight: 700;
      color: #FF6600;
    }

    .ticket-actions {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Poppins', sans-serif;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-details {
      background: #1976d2;
      color: white;
    }

    .btn-details:hover {
      background: #1565c0;
      transform: translateY(-2px);
    }

    .btn-cancel {
      background: #f44336;
      color: white;
    }

    .btn-cancel:hover {
      background: #d32f2f;
      transform: translateY(-2px);
    }

    .btn-cancel:disabled {
      background: #ccc;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .empty-state {
      background: white;
      border-radius: 16px;
      padding: 80px 20px;
      text-align: center;
    }

    .empty-icon {
      font-size: 100px;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      color: #333;
      font-size: 28px;
      margin-bottom: 12px;
    }

    .empty-state p {
      color: #666;
      font-size: 16px;
    }

    @media (max-width: 768px) {
      .tickets-section {
        padding: 60px 15px 30px;
      }

      .page-title h2 {
        font-size: 28px;
      }

      .ticket-header {
        padding-right: 0;
        flex-direction: column;
        gap: 12px;
      }

      .ticket-status-badge {
        position: static;
        align-self: flex-start;
      }

      .ticket-actions {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="container">
      <div class="header-content">
        <a href="index.html" class="logo">
          <div class="logo-text">
            <span class="logo-brand">VOOBUS</span>
          </div>
        </a>
        <nav class="nav-menu">
          <a href="index.html" class="nav-link">Trang ch·ªß</a>
          <a href="index.html#lookup" class="nav-link">Tra c·ª©u v√©</a>
          <a href="index.html#about" class="nav-link">V·ªÅ ch√∫ng t√¥i</a>
        </nav>

        <!-- Right Actions -->
        <div class="header-actions">
          <button class="btn-language">
            <img src="https://futabus.vn/images/icons/vietnam.svg" alt="VI" width="20">
            VI
          </button>

          <!-- Login Button (shown when not logged in) -->
          <a href="login_register.html" class="btn-login" id="btnLogin">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            ƒêƒÉng nh·∫≠p/ƒêƒÉng k√Ω
          </a>

          <!-- User Account Dropdown (shown when logged in) -->
          <div class="user-account" id="userAccount" style="display: none;">
            <button class="btn-account" onclick="toggleAccountMenu()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              <span id="userName">T√†i kho·∫£n</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                class="arrow-icon">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <div class="account-dropdown" id="accountDropdown">
              <div class="account-info">
                <div class="account-avatar">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                </div>
                <div class="account-details">
                  <div class="account-name" id="dropdownUserName">User</div>
                  <div class="account-email" id="dropdownUserEmail">email@example.com</div>
                </div>
              </div>
              <div class="account-divider"></div>
              <a href="profile.html" class="account-menu-item">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
                Th√¥ng tin c√° nh√¢n
              </a>
              <a href="my-tickets.html" class="account-menu-item">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                V√© c·ªßa t√¥i
              </a>
              <div class="account-divider"></div>
              <a href="#" class="account-menu-item logout" onclick="logout()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                  <polyline points="16 17 21 12 16 7"></polyline>
                  <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                ƒêƒÉng xu·∫•t
              </a>
            </div>
          </div>
        </div>

        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="M·ªü menu ƒëi·ªÅu h∆∞·ªõng" title="M·ªü menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
    </div>
  </header>

  <main>
    <section class="tickets-section">
      <div class="tickets-container">
        <a href="index.html" class="btn-back">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7" />
          </svg>
          Quay l·∫°i trang ch·ªß
        </a>
        <div class="page-title">
          <h2>V√© c·ªßa t√¥i</h2>
          <p>Qu·∫£n l√Ω v√† theo d√µi c√°c v√© xe c·ªßa b·∫°n</p>
        </div>
        <div class="tickets-grid" id="ticketsList"></div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="container">
      <div class="footer-bottom">
        <p>¬© 2025 VOOBUS - H·ªá Th·ªëng ƒê·∫∑t V√© Xe Kh√°ch. B·∫£o l∆∞u m·ªçi quy·ªÅn.</p>
      </div>
    </div>
  </footer>

  <!-- Cancel Ticket Modal -->
  <div class="cancel-modal-overlay" id="cancelModal">
    <div class="cancel-modal">
      <div class="cancel-modal-header">
        <h3>üé´ Y√™u c·∫ßu h·ªßy v√©</h3>
        <button class="cancel-modal-close" onclick="closeCancelModal()">‚úï</button>
      </div>
      <div class="cancel-modal-body">
        <div class="ticket-info-summary" id="cancelTicketInfo"></div>

        <div class="cancel-policy">
          <h4>üìã Ch√≠nh s√°ch h·ªßy v√©</h4>
          <ul>
            <li><strong>H·ªßy tr∆∞·ªõc 24h:</strong> Ho√†n 80% gi√° v√©</li>
            <li><strong>H·ªßy tr∆∞·ªõc 12h:</strong> Ho√†n 50% gi√° v√©</li>
            <li><strong>H·ªßy tr∆∞·ªõc 6h:</strong> Ho√†n 30% gi√° v√©</li>
            <li><strong>H·ªßy d∆∞·ªõi 6h:</strong> Kh√¥ng ho√†n ti·ªÅn</li>
          </ul>
        </div>

        <form id="cancelForm">
          <div class="form-group">
            <label for="cancelReason">L√Ω do h·ªßy v√© <span class="required">*</span></label>
            <select id="cancelReason" required>
              <option value="">-- Ch·ªçn l√Ω do --</option>
              <option value="change_schedule">Thay ƒë·ªïi l·ªãch tr√¨nh c√° nh√¢n</option>
              <option value="health_issue">V·∫•n ƒë·ªÅ s·ª©c kh·ªèe</option>
              <option value="duplicate_booking">ƒê·∫∑t v√© tr√πng l·∫∑p</option>
              <option value="wrong_info">Nh·∫≠p sai th√¥ng tin chuy·∫øn</option>
              <option value="emergency">Vi·ªác kh·∫©n c·∫•p</option>
              <option value="other">L√Ω do kh√°c</option>
            </select>
          </div>

          <div class="form-group" id="otherReasonGroup" style="display: none;">
            <label for="otherReason">M√¥ t·∫£ l√Ω do <span class="required">*</span></label>
            <textarea id="otherReason" rows="3" placeholder="Vui l√≤ng m√¥ t·∫£ chi ti·∫øt l√Ω do h·ªßy v√©..."></textarea>
          </div>

          <div class="form-group">
            <label for="cancelNote">Ghi ch√∫ th√™m (kh√¥ng b·∫Øt bu·ªôc)</label>
            <textarea id="cancelNote" rows="2" placeholder="Th√¥ng tin b·ªï sung n·∫øu c√≥..."></textarea>
          </div>

          <div class="refund-estimate" id="refundEstimate"></div>
        </form>
      </div>
      <div class="cancel-modal-footer">
        <button class="btn btn-secondary" onclick="closeCancelModal()">ƒê√≥ng</button>
        <button class="btn btn-cancel-submit" onclick="submitCancelRequest()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          G·ª≠i y√™u c·∫ßu h·ªßy
        </button>
      </div>
    </div>
  </div>

  <!-- Ticket Detail Modal -->
  <div class="detail-modal-overlay" id="detailModal">
    <div class="detail-modal">
      <div class="detail-modal-header">
        <h3>üé´ Chi ti·∫øt v√© xe</h3>
        <button class="detail-modal-close" onclick="closeDetailModal()">‚úï</button>
      </div>
      <div class="detail-modal-body" id="detailModalBody">
        <!-- Content will be loaded dynamically -->
      </div>
      <div class="detail-modal-footer">
        <button class="btn btn-secondary" onclick="closeDetailModal()">ƒê√≥ng</button>
        <button class="btn btn-print" onclick="printTicket()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 6 2 18 2 18 9"></polyline>
            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
            <rect x="6" y="14" width="12" height="8"></rect>
          </svg>
          In v√©
        </button>
      </div>
    </div>
  </div>

  <style>
    /* Cancel Modal Styles */
    .cancel-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .cancel-modal-overlay.active {
      display: flex;
    }

    .cancel-modal {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 560px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-30px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .cancel-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      background: linear-gradient(135deg, #FF6600 0%, #FF8C42 100%);
      color: white;
    }

    .cancel-modal-header h3 {
      margin: 0;
      font-size: 20px;
    }

    .cancel-modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.2s;
    }

    .cancel-modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .cancel-modal-body {
      padding: 24px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .ticket-info-summary {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .ticket-info-summary h4 {
      margin: 0 0 12px 0;
      color: #333;
    }

    .ticket-info-summary p {
      margin: 6px 0;
      color: #666;
      font-size: 14px;
    }

    .ticket-info-summary strong {
      color: #333;
    }

    .cancel-policy {
      background: #fff3e0;
      border: 1px solid #ffcc80;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .cancel-policy h4 {
      margin: 0 0 12px 0;
      color: #e65100;
    }

    .cancel-policy ul {
      margin: 0;
      padding-left: 20px;
    }

    .cancel-policy li {
      margin: 6px 0;
      color: #666;
      font-size: 13px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #333;
    }

    .form-group .required {
      color: #f44336;
    }

    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: 'Poppins', sans-serif;
      transition: border-color 0.2s;
    }

    .form-group select:focus,
    .form-group textarea:focus {
      border-color: #FF6600;
      outline: none;
    }

    .refund-estimate {
      background: #e8f5e9;
      border: 1px solid #a5d6a7;
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }

    .refund-estimate h4 {
      margin: 0 0 8px 0;
      color: #2e7d32;
    }

    .refund-estimate p {
      margin: 0;
      color: #1b5e20;
      font-size: 24px;
      font-weight: 700;
    }

    .refund-estimate .note {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }

    .cancel-modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      padding: 16px 24px;
      border-top: 1px solid #eee;
      background: #fafafa;
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #d0d0d0;
    }

    .btn-cancel-submit {
      background: linear-gradient(135deg, #FF6600 0%, #FF8C42 100%);
      color: white;
    }

    .btn-cancel-submit:hover {
      background: linear-gradient(135deg, #e55c00 0%, #e57a38 100%);
    }

    .status-cancel-pending {
      background: #9c27b0;
      color: white;
    }

    /* Detail Modal Styles */
    .detail-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .detail-modal-overlay.active {
      display: flex;
    }

    .detail-modal {
      background: white;
      border-radius: 20px;
      width: 95%;
      max-width: 650px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease;
    }

    .detail-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 28px;
      background: linear-gradient(135deg, #FF6600 0%, #FF8C42 100%);
      color: white;
    }

    .detail-modal-header h3 {
      margin: 0;
      font-size: 22px;
      font-weight: 700;
    }

    .detail-modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s;
    }

    .detail-modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .detail-modal-body {
      padding: 28px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .detail-modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      padding: 20px 28px;
      border-top: 1px solid #eee;
      background: #fafafa;
    }

    .btn-print {
      background: #1976d2;
      color: white;
    }

    .btn-print:hover {
      background: #1565c0;
    }

    /* Ticket Detail Card */
    .ticket-detail-card {
      background: #f8f9fa;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .ticket-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px dashed #ddd;
    }

    .ticket-detail-code {
      font-size: 24px;
      font-weight: 700;
      color: #FF6600;
    }

    .ticket-detail-status {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .ticket-route-display {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      padding: 20px 0;
      margin-bottom: 20px;
    }

    .route-point {
      text-align: center;
    }

    .route-point-label {
      font-size: 12px;
      color: #999;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .route-point-name {
      font-size: 20px;
      font-weight: 700;
      color: #333;
    }

    .route-arrow-big {
      font-size: 28px;
      color: #FF6600;
    }

    .ticket-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .ticket-info-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .ticket-info-icon {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, #FF6600 0%, #FF8C42 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      flex-shrink: 0;
    }

    .ticket-info-content {
      flex: 1;
    }

    .ticket-info-label {
      font-size: 12px;
      color: #999;
      margin-bottom: 2px;
    }

    .ticket-info-value {
      font-size: 15px;
      font-weight: 600;
      color: #333;
    }

    .ticket-info-value.price {
      color: #FF6600;
      font-size: 20px;
    }

    .ticket-qr-section {
      text-align: center;
      padding: 20px;
      background: white;
      border-radius: 12px;
      margin-top: 20px;
    }

    .ticket-qr-section h4 {
      margin: 0 0 16px 0;
      color: #333;
    }

    .ticket-qr-placeholder {
      width: 150px;
      height: 150px;
      background: #f0f0f0;
      border: 2px dashed #ddd;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      font-size: 60px;
      color: #ccc;
    }

    @media (max-width: 600px) {
      .ticket-info-grid {
        grid-template-columns: 1fr;
      }

      .ticket-route-display {
        flex-direction: column;
        gap: 10px;
      }

      .route-arrow-big {
        transform: rotate(90deg);
      }
    }
  </style>

  <script src="assets/scripts/core/toast.js?v=2"></script>
  <script src="assets/scripts/core/main.js?v=2"></script>
  <script>
    const API_BASE_URL = 'http://localhost:8000';
    let allTickets = [];
    let currentCancelTicket = null;

    // Helper function ƒë·ªÉ tr√≠ch xu·∫•t gi·ªù t·ª´ maLC (format: LC_CX001_2025-11-30_1000 -> 10:00)
    function extractTimeFromMaLC(maLC) {
      if (!maLC) return null;
      const parts = maLC.split('_');
      if (parts.length >= 4) {
        const timeStr = parts[parts.length - 1]; // L·∫•y ph·∫ßn cu·ªëi: "1000" ho·∫∑c "0600"
        if (timeStr.length === 4) {
          return `${timeStr.substring(0, 2)}:${timeStr.substring(2, 4)}`; // "10:00" ho·∫∑c "06:00"
        }
      }
      return null;
    }

    // Helper function ƒë·ªÉ tr√≠ch xu·∫•t ng√†y t·ª´ maLC (format: LC_CX001_2025-11-30_1000 -> 2025-11-30)
    function extractDateFromMaLC(maLC) {
      if (!maLC) return null;
      const parts = maLC.split('_');
      if (parts.length >= 4) {
        // L·∫•y ph·∫ßn ng√†y: "2025-11-30"
        return parts[2];
      }
      return null;
    }

    function formatDateTime(dateStr, timeStr) {
      if (!dateStr || dateStr === 'N/A') return 'N/A';
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) return 'N/A';
      const formatted = date.toLocaleDateString('vi-VN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
      return timeStr ? `${formatted} ${timeStr}` : formatted;
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('vi-VN', {

        const diemDi = ticket.chuyenXe?.diemDi || ticket.diemDi || 'N/A';
        const diemDen = ticket.chuyenXe?.diemDen || ticket.diemDen || 'N/A';
        const seats = ticket.maGhe || 'N/A';
        const statusInfo = getStatusInfo(ticket.trangThai);
        const ngayKhoiHanh = ticket.lichChay?.ngayKhoiHanh || ticket.ngayDi || extractDateFromMaLC(ticket.maLC) || 'N/A';
        const gioKhoiHanh = ticket.lichChay?.gioKhoiHanh || ticket.lichChay?.thoiGianXuatBen || extractTimeFromMaLC(ticket.maLC) || 'N/A';
        const giaVe = ticket.chuyenXe?.giaChuyenXe || ticket.giaVe || 0;

        const modalBody = document.getElementById('detailModalBody');
        modalBody.innerHTML = `
        <div class="ticket-detail-card">
          <div class="ticket-detail-header">
            <div class="ticket-detail-code">${maVe}</div>
            <div class="ticket-detail-status ${statusInfo.class}">${statusInfo.text}</div>
          </div>
          
          <div class="ticket-route-display">
            <div class="route-point">
              <div class="route-point-label">ƒêi·ªÉm ƒëi</div>
              <div class="route-point-name">${diemDi}</div>
            </div>
            <div class="route-arrow-big">‚Üí</div>
            <div class="route-point">
              <div class="route-point-label">ƒêi·ªÉm ƒë·∫øn</div>
              <div class="route-point-name">${diemDen}</div>
            </div>
          </div>
          
          <div class="ticket-info-grid">
            <div class="ticket-info-item">
              <div class="ticket-info-icon">üìÖ</div>
              <div class="ticket-info-content">
                <div class="ticket-info-label">Ng√†y kh·ªüi h√†nh</div>
                <div class="ticket-info-value">${formatDateTime(ngayKhoiHanh, null)}</div>
              </div>
            </div>
            <div class="ticket-info-item">
              <div class="ticket-info-icon">üïê</div>
              <div class="ticket-info-content">
                <div class="ticket-info-label">Gi·ªù xu·∫•t b·∫øn</div>
                <div class="ticket-info-value">${gioKhoiHanh}</div>
              </div>
            </div>
            <div class="ticket-info-item">
              <div class="ticket-info-icon">üí∫</div>
              <div class="ticket-info-content">
                <div class="ticket-info-label">S·ªë gh·∫ø</div>
                <div class="ticket-info-value">${seats}</div>
              </div>
            </div>
            <div class="ticket-info-item">
              <div class="ticket-info-icon">üé´</div>
              <div class="ticket-info-content">
                <div class="ticket-info-label">S·ªë l∆∞·ª£ng v√©</div>
                <div class="ticket-info-value">1 v√©</div>
              </div>
            </div>
            <div class="ticket-info-item">
              <div class="ticket-info-icon">üöå</div>
              <div class="ticket-info-content">
                <div class="ticket-info-label">Lo·∫°i xe</div>
                <div class="ticket-info-value">${ticket.chuyenXe?.loaiXe || 'Limousine'}</div>
              </div>
            </div>
            <div class="ticket-info-item">
              <div class="ticket-info-icon">üí∞</div>
              <div class="ticket-info-content">
                <div class="ticket-info-label">Gi√° v√©</div>
                <div class="ticket-info-value price">${formatCurrency(giaVe)}</div>
              </div>
            </div>
          </div>
          
          ${ticket.ngayThanhToan ? `
          <div class="ticket-info-grid" style="margin-top: 16px;">
            <div class="ticket-info-item">
              <div class="ticket-info-icon" style="background: linear-gradient(135deg, #4caf50 0%, #81c784 100%);">‚úì</div>
              <div class="ticket-info-content">
                <div class="ticket-info-label">Ng√†y thanh to√°n</div>
                <div class="ticket-info-value">${formatDateTime(ticket.ngayThanhToan, null)}</div>
              </div>
            </div>
          </div>
          ` : ''}
          
          <div class="ticket-qr-section">
            <h4>M√£ QR v√© ƒëi·ªán t·ª≠</h4>
            <div class="ticket-qr-placeholder">üì±</div>
            <p style="margin-top: 12px; color: #666; font-size: 13px;">Xu·∫•t tr√¨nh m√£ n√†y khi l√™n xe</p>
          </div>
        </div>
      `;

        document.getElementById('detailModal').classList.add('active');
      }

    function closeDetailModal() {
          document.getElementById('detailModal').classList.remove('active');
        }

    function printTicket() {
          window.print();
          Toast.info('ƒêang chu·∫©n b·ªã in v√©...');
        }

    function openCancelModal(maVe) {
          const ticket = allTickets.find(t => t.maVe === maVe);
          if (!ticket) return;

          currentCancelTicket = ticket;

          const diemDi = ticket.chuyenXe?.diemDi || ticket.diemDi || 'N/A';
          const diemDen = ticket.chuyenXe?.diemDen || ticket.diemDen || 'N/A';
          const route = `${diemDi} - ${diemDen}`;
          const seats = ticket.maGhe || 'N/A';
          const ngayKhoiHanh = ticket.lichChay?.ngayKhoiHanh || ticket.ngayDi || extractDateFromMaLC(ticket.maLC) || 'N/A';
          const gioKhoiHanh = ticket.lichChay?.gioKhoiHanh || extractTimeFromMaLC(ticket.maLC) || '';
          const giaVe = ticket.chuyenXe?.giaChuyenXe || ticket.giaVe || 0;

          // Show ticket info
          document.getElementById('cancelTicketInfo').innerHTML = `
        <h4>Th√¥ng tin v√©</h4>
        <p><strong>M√£ v√©:</strong> ${ticket.maVe}</p>
        <p><strong>Tuy·∫øn:</strong> ${route}</p>
        <p><strong>Ng√†y kh·ªüi h√†nh:</strong> ${formatDateTime(ngayKhoiHanh, gioKhoiHanh)}</p>
        <p><strong>Gh·∫ø:</strong> ${seats}</p>
        <p><strong>Gi√° v√©:</strong> ${formatCurrency(giaVe)}</p>
      `;

          // Calculate refund estimate
          calculateRefund(ticket);

          // Reset form
          document.getElementById('cancelForm').reset();
          document.getElementById('otherReasonGroup').style.display = 'none';

          // Show modal
          document.getElementById('cancelModal').classList.add('active');
        }

    function closeCancelModal() {
          document.getElementById('cancelModal').classList.remove('active');
          currentCancelTicket = null;
        }

    function calculateRefund(ticket) {
          const ngayKhoiHanh = ticket.lichChay?.ngayKhoiHanh || ticket.ngayDi || extractDateFromMaLC(ticket.maLC) || new Date().toISOString().split('T')[0];
          const gioKhoiHanh = ticket.lichChay?.gioKhoiHanh || extractTimeFromMaLC(ticket.maLC) || '00:00';
          const departureDate = new Date(`${ngayKhoiHanh}T${gioKhoiHanh}`);
          const now = new Date();
          const hoursUntilDeparture = (departureDate - now) / (1000 * 60 * 60);
          const giaVe = ticket.chuyenXe?.giaChuyenXe || ticket.giaVe || 0;

          let refundPercent = 0;
          let message = '';

          if (hoursUntilDeparture >= 24) {
            refundPercent = 80;
            message = 'H·ªßy tr∆∞·ªõc 24 gi·ªù - Ho√†n 80%';
          } else if (hoursUntilDeparture >= 12) {
            refundPercent = 50;
            message = 'H·ªßy tr∆∞·ªõc 12 gi·ªù - Ho√†n 50%';
          } else if (hoursUntilDeparture >= 6) {
            refundPercent = 30;
            message = 'H·ªßy tr∆∞·ªõc 6 gi·ªù - Ho√†n 30%';
          } else if (hoursUntilDeparture > 0) {
            refundPercent = 0;
            message = 'H·ªßy d∆∞·ªõi 6 gi·ªù - Kh√¥ng ho√†n ti·ªÅn';
          } else {
            refundPercent = 0;
            message = 'Chuy·∫øn xe ƒë√£ kh·ªüi h√†nh - Kh√¥ng th·ªÉ h·ªßy';
          }

          const refundAmount = giaVe * refundPercent / 100;

          document.getElementById('refundEstimate').innerHTML = `
        <h4>üíµ ∆Ø·ªõc t√≠nh ho√†n ti·ªÅn</h4>
        <p>${formatCurrency(refundAmount)}</p>
        <div class="note">${message}</div>
        ${refundPercent === 0 && hoursUntilDeparture <= 0 ?
              '<div style="color: #d32f2f; margin-top: 8px; font-weight: 500;">‚ö†Ô∏è Chuy·∫øn xe ƒë√£ kh·ªüi h√†nh, kh√¥ng th·ªÉ h·ªßy v√©!</div>' : ''}
      `;

          return { refundPercent, refundAmount, canCancel: hoursUntilDeparture > 0 };
        }

    // Show/hide other reason textarea
    document.getElementById('cancelReason').addEventListener('change', function () {
          const otherGroup = document.getElementById('otherReasonGroup');
          if (this.value === 'other') {
            otherGroup.style.display = 'block';
            document.getElementById('otherReason').required = true;
          } else {
            otherGroup.style.display = 'none';
            document.getElementById('otherReason').required = false;
          }
        });

      async function submitCancelRequest() {
        if (!currentCancelTicket) return;

        const reasonSelect = document.getElementById('cancelReason');
        const otherReason = document.getElementById('otherReason').value.trim();
        const note = document.getElementById('cancelNote').value.trim();

        if (!reasonSelect.value) {
          Toast.warning('Vui l√≤ng ch·ªçn l√Ω do h·ªßy v√©');
          return;
        }

        if (reasonSelect.value === 'other' && !otherReason) {
          Toast.warning('Vui l√≤ng m√¥ t·∫£ chi ti·∫øt l√Ω do h·ªßy v√©');
          return;
        }

        // Check if departure has passed
        const refundInfo = calculateRefund(currentCancelTicket);
        if (!refundInfo.canCancel) {
          Toast.error('Chuy·∫øn xe ƒë√£ kh·ªüi h√†nh, kh√¥ng th·ªÉ h·ªßy v√©!');
          return;
        }

        const reasonLabels = {
          'change_schedule': 'Thay ƒë·ªïi l·ªãch tr√¨nh c√° nh√¢n',
          'health_issue': 'V·∫•n ƒë·ªÅ s·ª©c kh·ªèe',
          'duplicate_booking': 'ƒê·∫∑t v√© tr√πng l·∫∑p',
          'wrong_info': 'Nh·∫≠p sai th√¥ng tin chuy·∫øn',
          'emergency': 'Vi·ªác kh·∫©n c·∫•p',
          'other': 'L√Ω do kh√°c'
        };

        const cancelData = {
          maDatVe: currentCancelTicket.maVe,
          lyDoHuy: reasonSelect.value,
          lyDoHuyText: reasonSelect.value === 'other' ? otherReason : reasonLabels[reasonSelect.value],
          ghiChu: note,
          tienHoanDuKien: refundInfo.refundAmount,
          phanTramHoan: refundInfo.refundPercent
        };

        const token = localStorage.getItem('token') || localStorage.getItem('access_token');

        try {
          const res = await fetch(`${API_BASE_URL}/api/v1/bookings/cancel-request`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(cancelData)
          });

          if (!res.ok) {
            const body = await res.json().catch(() => ({}));
            throw new Error(body.detail || 'Kh√¥ng th·ªÉ g·ª≠i y√™u c·∫ßu h·ªßy v√©');
          }

          Toast.success('Y√™u c·∫ßu h·ªßy v√© ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng! Vui l√≤ng ch·ªù admin duy·ªát.');
          closeCancelModal();
          setTimeout(loadTickets, 800);

        } catch (err) {
          console.error(err);
          Toast.error(err.message || 'G·ª≠i y√™u c·∫ßu th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i sau.');
        }
      }

      document.addEventListener('DOMContentLoaded', loadTickets);
  </script>
</body>

</html>